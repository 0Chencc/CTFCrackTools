name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.0)'
        required: true
        type: string

# Ensure only one release workflow runs at a time
concurrency:
  group: release
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  APP_NAME: 'CTFCrackTools X'

jobs:
  # ============================================================
  # Pre-release Validation
  # ============================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Determine tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION (tag: $TAG)"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.version.outputs.tag }}

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev patchelf libgtk-3-dev
          version: 1.0

      - uses: pnpm/action-setup@v4
        with: { version: 9 }
      - uses: actions/setup-node@v4
        with: { node-version: 22, cache: 'pnpm' }
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: validate

      - run: pnpm install --frozen-lockfile

      - name: Frontend checks
        run: |
          pnpm tsc --noEmit
          pnpm lint

      - name: Rust checks
        working-directory: src-tauri
        run: |
          cargo fmt --all -- --check
          cargo clippy --all-targets --all-features -- -D warnings
          cargo test --all-features

  # ============================================================
  # Build Linux
  # ============================================================
  build-linux:
    name: Build Linux
    runs-on: ubuntu-24.04
    needs: [validate]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.tag }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev patchelf libgtk-3-dev

      - uses: pnpm/action-setup@v4
        with: { version: 9 }
      - uses: actions/setup-node@v4
        with: { node-version: 22, cache: 'pnpm' }
      - uses: dtolnay/rust-toolchain@stable
        with: { targets: 'x86_64-unknown-linux-gnu' }
      - uses: Swatinem/rust-cache@v2
        with: { workspaces: src-tauri, shared-key: 'release-linux' }

      - name: Sync version from tag
        env:
          VERSION: ${{ needs.validate.outputs.version }}
        run: |
          node -e '
            const fs = require("fs");
            const v = process.env.VERSION;
            const pkg = JSON.parse(fs.readFileSync("package.json", "utf8"));
            pkg.version = v;
            fs.writeFileSync("package.json", JSON.stringify(pkg, null, 2) + "\n");
            const conf = JSON.parse(fs.readFileSync("src-tauri/tauri.conf.json", "utf8"));
            conf.version = v;
            fs.writeFileSync("src-tauri/tauri.conf.json", JSON.stringify(conf, null, 2) + "\n");
            let toml = fs.readFileSync("src-tauri/Cargo.toml", "utf8");
            toml = toml.replace(/^version = ".*"/m, `version = "${v}"`);
            fs.writeFileSync("src-tauri/Cargo.toml", toml);
            console.log("Synced version to " + v);
          '

      - run: pnpm install --frozen-lockfile
      - run: pnpm tauri build --no-bundle --target x86_64-unknown-linux-gnu

      - name: Prepare artifacts
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          mkdir -p release
          cp src-tauri/target/x86_64-unknown-linux-gnu/release/ctfcracktools-x \
             "release/ctfcracktools-x-${VERSION}-linux-x64"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: release/
          retention-days: 30

  # ============================================================
  # Build Windows
  # ============================================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: [validate]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.tag }}

      - uses: pnpm/action-setup@v4
        with: { version: 9 }
      - uses: actions/setup-node@v4
        with: { node-version: 22, cache: 'pnpm' }
      - uses: dtolnay/rust-toolchain@stable
        with: { targets: 'x86_64-pc-windows-msvc' }
      - uses: Swatinem/rust-cache@v2
        with: { workspaces: src-tauri, shared-key: 'release-windows' }

      - name: Sync version from tag
        shell: bash
        env:
          VERSION: ${{ needs.validate.outputs.version }}
        run: |
          node -e '
            const fs = require("fs");
            const v = process.env.VERSION;
            const pkg = JSON.parse(fs.readFileSync("package.json", "utf8"));
            pkg.version = v;
            fs.writeFileSync("package.json", JSON.stringify(pkg, null, 2) + "\n");
            const conf = JSON.parse(fs.readFileSync("src-tauri/tauri.conf.json", "utf8"));
            conf.version = v;
            fs.writeFileSync("src-tauri/tauri.conf.json", JSON.stringify(conf, null, 2) + "\n");
            let toml = fs.readFileSync("src-tauri/Cargo.toml", "utf8");
            toml = toml.replace(/^version = ".*"/m, `version = "${v}"`);
            fs.writeFileSync("src-tauri/Cargo.toml", toml);
            console.log("Synced version to " + v);
          '

      - run: pnpm install --frozen-lockfile
      - run: pnpm tauri build --no-bundle --target x86_64-pc-windows-msvc

      - name: Prepare artifacts
        shell: bash
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          mkdir -p release
          cp src-tauri/target/x86_64-pc-windows-msvc/release/ctfcracktools-x.exe \
             "release/ctfcracktools-x-${VERSION}-windows-x64.exe"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: release/
          retention-days: 30

  # ============================================================
  # Build macOS ARM64
  # ============================================================
  build-macos-arm64:
    name: Build macOS ARM64
    runs-on: macos-latest
    needs: [validate]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.tag }}

      - uses: pnpm/action-setup@v4
        with: { version: 9 }
      - uses: actions/setup-node@v4
        with: { node-version: 22, cache: 'pnpm' }
      - uses: dtolnay/rust-toolchain@stable
        with: { targets: 'aarch64-apple-darwin' }
      - uses: Swatinem/rust-cache@v2
        with: { workspaces: src-tauri, shared-key: 'release-macos-arm64' }

      - name: Sync version from tag
        env:
          VERSION: ${{ needs.validate.outputs.version }}
        run: |
          node -e '
            const fs = require("fs");
            const v = process.env.VERSION;
            const pkg = JSON.parse(fs.readFileSync("package.json", "utf8"));
            pkg.version = v;
            fs.writeFileSync("package.json", JSON.stringify(pkg, null, 2) + "\n");
            const conf = JSON.parse(fs.readFileSync("src-tauri/tauri.conf.json", "utf8"));
            conf.version = v;
            fs.writeFileSync("src-tauri/tauri.conf.json", JSON.stringify(conf, null, 2) + "\n");
            let toml = fs.readFileSync("src-tauri/Cargo.toml", "utf8");
            toml = toml.replace(/^version = ".*"/m, `version = "${v}"`);
            fs.writeFileSync("src-tauri/Cargo.toml", toml);
            console.log("Synced version to " + v);
          '

      - run: pnpm install --frozen-lockfile
      - run: pnpm tauri build --target aarch64-apple-darwin

      - name: Prepare artifacts
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          mkdir -p release
          cp src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg \
             "release/ctfcracktools-x-${VERSION}-macos-arm64.dmg"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-release
          path: release/
          retention-days: 30

  # ============================================================
  # Build macOS Intel
  # ============================================================
  build-macos-intel:
    name: Build macOS Intel
    runs-on: macos-15-intel
    needs: [validate]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.tag }}

      - uses: pnpm/action-setup@v4
        with: { version: 9 }
      - uses: actions/setup-node@v4
        with: { node-version: 22, cache: 'pnpm' }
      - uses: dtolnay/rust-toolchain@stable
        with: { targets: 'x86_64-apple-darwin' }
      - uses: Swatinem/rust-cache@v2
        with: { workspaces: src-tauri, shared-key: 'release-macos-intel' }

      - name: Sync version from tag
        env:
          VERSION: ${{ needs.validate.outputs.version }}
        run: |
          node -e '
            const fs = require("fs");
            const v = process.env.VERSION;
            const pkg = JSON.parse(fs.readFileSync("package.json", "utf8"));
            pkg.version = v;
            fs.writeFileSync("package.json", JSON.stringify(pkg, null, 2) + "\n");
            const conf = JSON.parse(fs.readFileSync("src-tauri/tauri.conf.json", "utf8"));
            conf.version = v;
            fs.writeFileSync("src-tauri/tauri.conf.json", JSON.stringify(conf, null, 2) + "\n");
            let toml = fs.readFileSync("src-tauri/Cargo.toml", "utf8");
            toml = toml.replace(/^version = ".*"/m, `version = "${v}"`);
            fs.writeFileSync("src-tauri/Cargo.toml", toml);
            console.log("Synced version to " + v);
          '

      - run: pnpm install --frozen-lockfile
      - run: pnpm tauri build --target x86_64-apple-darwin

      - name: Prepare artifacts
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          mkdir -p release
          cp src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg \
             "release/ctfcracktools-x-${VERSION}-macos-x64.dmg"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-release
          path: release/
          retention-days: 30

  # ============================================================
  # Create GitHub Release
  # ============================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate, build-linux, build-windows, build-macos-arm64, build-macos-intel]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.tag }}
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Organize release files
        run: |
          mkdir -p release

          cp artifacts/linux-release/* release/ 2>/dev/null || true
          cp artifacts/windows-release/* release/ 2>/dev/null || true
          cp artifacts/macos-arm64-release/* release/ 2>/dev/null || true
          cp artifacts/macos-intel-release/* release/ 2>/dev/null || true

          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt || true
          cat SHA256SUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ env.APP_NAME }} v${{ needs.validate.outputs.version }}"
          tag_name: ${{ needs.validate.outputs.tag }}
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.tag, '-beta') || contains(needs.validate.outputs.tag, '-alpha') || contains(needs.validate.outputs.tag, '-rc') }}
          generate_release_notes: true
          files: |
            release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
